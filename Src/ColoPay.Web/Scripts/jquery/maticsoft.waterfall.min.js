/*
* File:        maticsoft.waterfall.js
* Author:      yaoyuan@ys56.com
* Copyright Â© 2004-2013 YSWL. All Rights Reserved.
*/$(function () { waterFall.ScrollTop = document.documentElement.scrollTop || document.body.scrollTop }); var waterFall = { AjaxOptions: { Type: "POST", Params: {}, DataURL: null, Async: true, DataType: "html", Success: null, Error: null }, CurrentAjaxStartIndexHF: null, StartIndex: 0, EndIndex: 0, PagedContainer: null, ColumnFirstId: null, ColumnNumber: 3, RowNumber: 0, LoadDataCount: 0, ScrollTop: 0, LoadFinish: false, ScrollTrigger: 100, scroll: function () { $(window).scroll(function () { var scrollTop = document.documentElement.scrollTop || document.body.scrollTop; if (!waterFall.LoadFinish && Math.abs(scrollTop - waterFall.ScrollTop) > waterFall.ScrollTrigger) { waterFall.ScrollTop = scrollTop; waterFall.appendDetect() } }); return this }, appendDetect: function () { var eleColumn; if (waterFall.ColumnNumber) { var start = 0; for (start; start < waterFall.ColumnNumber; start++) { eleColumn = document.getElementById(waterFall.ColumnFirstId + start); if (eleColumn && !waterFall.LoadFinish) { if (eleColumn.offsetTop + eleColumn.clientHeight < waterFall.ScrollTop + (window.innerHeight || document.documentElement.clientHeight)) { waterFall.append(eleColumn) } } } } else { eleColumn = document.getElementById(waterFall.ColumnFirstId); if (eleColumn && !waterFall.LoadFinish) { if (eleColumn.offsetTop + eleColumn.clientHeight < waterFall.ScrollTop + (window.innerHeight || document.documentElement.clientHeight)) { waterFall.append(eleColumn); if (waterFall.RowNumber && waterFall.RowNumber > 1) { for (var rowIndex = 2; rowIndex < waterFall.RowNumber; rowIndex++) { waterFall.append(eleColumn) } } } } } return this }, append: function (column) { if (waterFall.StartIndex >= waterFall.EndIndex) { waterFall.LoadFinish = true; waterFall.PagedContainer.show(); return this } var baseData = { StartIndex: waterFall.StartIndex }; waterFall.LoadDataCount += 1; if ($("#hfCurrentPageAjaxSize").length > 0) { waterFall.StartIndex = waterFall.StartIndex + parseInt($("#hfCurrentPageAjaxSize").val()); waterFall.CurrentAjaxStartIndexHF.val(waterFall.StartIndex) } else { waterFall.CurrentAjaxStartIndexHF.val(++waterFall.StartIndex) } $.ajax({ type: waterFall.AjaxOptions.Type, url: waterFall.AjaxOptions.DataURL, async: waterFall.AjaxOptions.Async, dataType: waterFall.AjaxOptions.DataType, data: $.extend(waterFall.AjaxOptions.Params, baseData), success: function (data) { if (!data) { waterFall.LoadFinish = true; waterFall.PagedContainer.show(); return } var jqData = $($.parseHTML(data)); $(column).append(jqData); if (waterFall.AjaxOptions.Success) { waterFall.AjaxOptions.Success.call(jqData) } }, error: function (event, XMLHttpRequest, ajaxOptions, thrownError) { if (waterFall.AjaxOptions.Error) { waterFall.AjaxOptions.Error.call(event, XMLHttpRequest, ajaxOptions, thrownError) } } }); if (waterFall.StartIndex >= waterFall.EndIndex) { waterFall.LoadFinish = true; waterFall.PagedContainer.show(); return this } return this }, refresh: function () { waterFall.appendDetect(); return this }, resize: function () { window.onresize = function () { waterFall.refresh() }; return this }, init: function (options) { var defaultOptions = { AjaxOptions: { Params: { AlbumId: $.getUrlParam("AlbumID") }, DataURL: "WaterfallPhotoListData" }, CurrentAjaxStartIndexHF: $("#hfCurrentPageAjaxStartIndex"), StartIndex: $("#hfCurrentPageAjaxStartIndex").val() ? parseInt($("#hfCurrentPageAjaxStartIndex").val()) : 0, EndIndex: $("#hfCurrentPageAjaxEndIndex").val() ? parseInt($("#hfCurrentPageAjaxEndIndex").val()) : 0, PagedContainer: $(".in_pages"), ColumnFirstId: "col_", ColumnNumber: 3, RowNumber: 0, ScrollTrigger: 100 }; if (options) { defaultOptions = $.extend(defaultOptions, options) } defaultOptions.PagedContainer.hide(); if (defaultOptions.CurrentAjaxStartIndexHF.length == 0) { return } if (defaultOptions.StartIndex == 0 || defaultOptions.EndIndex == 0) { return } this.CurrentAjaxStartIndexHF = defaultOptions.CurrentAjaxStartIndexHF; this.ColumnFirstId = defaultOptions.ColumnFirstId; this.ColumnNumber = defaultOptions.ColumnNumber; this.RowNumber = defaultOptions.RowNumber; this.PagedContainer = defaultOptions.PagedContainer; this.StartIndex = defaultOptions.StartIndex; this.EndIndex = defaultOptions.EndIndex; this.AjaxOptions = $.extend(this.AjaxOptions, defaultOptions.AjaxOptions); if (this.StartIndex && this.ColumnFirstId) { $(document).scrollTop(0); this.LoadFinish = false; this.scroll().refresh().resize() } } };